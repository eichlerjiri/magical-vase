<!DOCTYPE html>
<html style="height: 100%;">
	<head>
		<title>Magical Vase</title>
		<meta name="viewport" content="initial-scale=1, user-scalable=0">
	</head>
	<body id="body" style="height: 100%; overflow: hidden;">
		<div id="canvasPre">
			<h1 style="display: inline; margin-left: 0.2em;">Magical Vase</h1><span style="margin-left: 1em;">density: </span><input id="densityInput" value="5" type="number" min="1" style="width: 3em;"><input id="applyButton" type="button" value="apply"><input id="clearButton" type="button" value="clear" style="margin-left: 0.5em;"><span id="hintText" style="margin-left: 0.5em; color: #008000;">start by dragging by the grey line</span>
		</div>
		<canvas id="c" style="border: 1px solid #000000;"></canvas>
		<style>
			* {
				margin: 0;
				padding: 0;
				border-width: 0;
				font-size: 1em;
				vertical-align: baseline;
			}

			input {
				border: 1px solid #808080;
				padding: 0.2em 0.3em 0.2em 0.3em;
			}

			input[type=button] {
				background-color: #E0E0E0;
			}

			input[type=button]:active {
				background-color: #A0A0A0;
			}
		</style>
		<script>
			var c = document.getElementById("c");
			var densityInput = document.getElementById("densityInput");
			var body = document.getElementById("body");
			var canvasPre = document.getElementById("canvasPre");
			var hintText = document.getElementById("hintText");
			var clearButton = document.getElementById("clearButton");
			var applyButton = document.getElementById("applyButton");

			var ctx = c.getContext("2d");
			var pixelRatio = window.devicePixelRatio;
			if(typeof pixelRatio === "undefined") {
				pixelRatio = 1;
			}

			var data = [];
			var density = 0;

			var dragging = false;
			var lastY = 0;
			var lastVal = 0;

			window.onresize = function() {
				resizeAll();
			}

			window.onload = function() {
				resizeAll();
				updateDensity();
			}

			function resizeAll() {
				var width = (body.offsetWidth - 2);
				var height = (body.offsetHeight - canvasPre.offsetHeight - 2);

				c.width = width * window.devicePixelRatio;
				c.height = height * window.devicePixelRatio;
				c.style.width = width + "px";
				c.style.height = height + "px";

				var newLength = Math.round(c.height);
				if(data.length < newLength) {
					data.length = newLength;
				}

				drawCircles();
			}

			densityInput.onchange = function() {
				return handleDensityChange();
			}

			applyButton.onclick = function() {
				return handleDensityChange();
			}

			function handleDensityChange() {
				updateDensity();
				drawCircles();

				return false;
			}

			c.onmousedown = function(event) {
				return handleStart(event.clientX, event.clientY);
			}

			c.ontouchstart = function(event) {
				return handleStart(event.changedTouches[0].clientX, event.changedTouches[0].clientY);
			}

			function handleStart(x, y) {
				x *= pixelRatio;
				y *= pixelRatio;

				dragging = true;
				lastY = Math.round(y - c.getBoundingClientRect().top);
				lastVal = Math.abs(x - c.getBoundingClientRect().left - c.width / 2);

				if(hintText.style.display != "none") {
					hintText.style.display = "none";
					resizeAll();
				}

				return false;
			}

			c.oncontextmenu = function() {
				return handleClear();
			}

			clearButton.onclick = function() {
				return handleClear();
			}

			function handleClear() {
				data = [];
				data.length = Math.round(c.height);

				drawCircles();

				return false;
			}

			window.onmouseup = function(event) {
				return handleEnd();
			}

			c.ontouchend = function(event) {
				return handleEnd();
			}

			c.ontouchcancel = function(event) {
				return handleEnd();
			}

			function handleEnd() {
				if(dragging) {
					dragging = false;

					return false;
				}
			}

			c.ontouchmove = function(event) {
				return handleMove(event.changedTouches[0].clientX, event.changedTouches[0].clientY);
			}

			window.onmousemove = function(event) {
				return handleMove(event.clientX, event.clientY);
			}

			function handleMove(x, y) {
				if(dragging) {
					x *= pixelRatio;
					y *= pixelRatio;

					var y = Math.round(y - c.getBoundingClientRect().top);
					var val = Math.abs(x - c.getBoundingClientRect().left - c.width / 2);

					var length = data.length;
					var sth = false;

					for(var i = lastY + 1; i <= y; i++) {
						if(i >= 0 && i < length) {
							data[i] = lastVal + (val - lastVal) * (i - lastY) / (y - lastY);
							sth = true;
						}
					}
					for(var i = y; i < lastY; i++) {
						if(i >= 0 && i < length) {
							data[i] = lastVal + (val - lastVal) * (i - lastY) / (y - lastY);
							sth = true;
						}
					}

					if(sth) {
						drawCircles();
					}

					lastY = y;
					lastVal = val;

					return false;
				}
			};

			function updateDensity() {
				density = parseInt(densityInput.value);
				if(isNaN(density) || density <= 0) {
					density = 5;
				}
				densityInput.value = density.toString();
			}

			function drawCircles() {
				var xpos = c.width / 2;
				var angle = 2 * Math.PI;

				ctx.clearRect(0, 0, c.width, c.height);

		 		ctx.strokeStyle = "#BBBBBB";
				ctx.beginPath();
				ctx.moveTo(xpos, 0);
				ctx.lineTo(xpos, c.height);
				ctx.stroke();

				for (var i = data.length - 1; i >= 0; i--) {
					var val = data[i];

					if(i % density != 0 || typeof val === "undefined") {
						continue;
					}

					var grd = ctx.createLinearGradient(0, i - val, 0, i + val);
					grd.addColorStop(0, "#EEEEEE");
					grd.addColorStop(1, "#000000");

		 			ctx.strokeStyle = grd;
					ctx.beginPath();
					ctx.arc(xpos, i, val, 0, angle);
					ctx.stroke();
				}
			}
		</script>
	</body>
</html>
